name: Documentation

on:
  push:
    tags:
    - v*
  workflow_dispatch:

permissions:
  contents: write # To push a branch
  pages: write # To push to Github Pages site
  id-token: write # To update deployment status

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v5
      with:
        fetch-depth: 0

      # Use MDBOOK_VERSION environment variable for better control
    - name: Set mdbook version
      run: echo "MDBOOK_VERSION=0.4.52" >> $GITHUB_ENV

    - name: Install mdBook
      run: |
        mkdir -p $HOME/.local/bin
        curl -sSL https://github.com/rust-lang/mdBook/releases/download/v$MDBOOK_VERSION/mdbook-v$MDBOOK_VERSION-x86_64-unknown-linux-gnu.tar.gz | tar -xz -C $HOME/.local/bin
        echo "$HOME/.local/bin" >> $GITHUB_PATH

      # Cache mdbook plugins
    - name: Cache mdbook plugins
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin
        key: ${{ runner.os }}-mdbook-plugins-${{ hashFiles('**/book.toml') }}

    - name: Install mdbook plugins
      run: |
        if ! command -v mdbook-alerts &> /dev/null; then
          cargo install mdbook-alerts --version 0.7.0
        fi
        if ! command -v mdbook-langtabs &> /dev/null; then
          cargo install mdbook-langtabs --version 0.1.1
        fi

    - name: Setup Pages
      uses: actions/configure-pages@v5
    - name: Build Book
      run: |
        mdbook --version
        mdbook build ./docs
        touch ./docs/book/.nojekyll

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v4
      with:
          # Upload entire repository
        path: ./docs/book

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
